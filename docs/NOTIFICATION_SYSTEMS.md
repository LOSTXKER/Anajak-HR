# 📱 ระบบการแจ้งเตือน (Notification Systems)

ระบบมีการแจ้งเตือน **2 ประเภท** ที่แยกกันโดยสิ้นเชิง:

---

## 🟢 1. LINE Notifications (Server-side)
**ส่งผ่าน LINE Messaging API → ไปที่ LINE App**

### ✅ ข้อดี:
- ✨ **ทำงานได้จริง 100%** (ถ้าตั้งค่า LINE API แล้ว)
- 📲 แจ้งเตือนไปที่ LINE โดยตรง
- 🔔 แจ้งเตือนได้แม้ปิด browser
- 🌐 ทำงานบน Server (Vercel)
- ⏰ มี Cron Job รันอัตโนมัติ

### 📋 แจ้งเตือนอะไรบ้าง:

| เหตุการณ์ | เมื่อไร | ไฟล์ที่ใช้ |
|----------|---------|-----------|
| **เช็คอิน** | เมื่อพนักงานเช็คอิน | `app/api/checkin-notification/route.ts` |
| **เช็คเอาท์** | เมื่อพนักงานเช็คเอาท์ | `app/api/checkout-notification/route.ts` |
| **OT - คำขอใหม่** | เมื่อมีคำขอ OT | `app/api/notifications/route.ts` |
| **OT - อนุมัติ/ปฏิเสธ** | เมื่อ admin อนุมัติ/ปฏิเสธ | `app/api/notifications/route.ts` |
| **OT - เริ่มทำ** | เมื่อเริ่มทำ OT | ส่งจากหน้า OT Start |
| **OT - จบ** | เมื่อจบ OT | ส่งจากหน้า OT End |
| **ลาพักร้อน** | เมื่ออนุมัติ/ปฏิเสธ | `app/api/notifications/route.ts` |
| **WFH** | เมื่ออนุมัติ/ปฏิเสธ | `app/api/notifications/route.ts` |
| **วันหยุด** | 🕐 09:00 ทุกวัน (Cron) | `app/api/holiday-notifications/route.ts` |
| **Auto Checkout** | 🕐 22:00 ทุกวัน (Cron) | `app/api/auto-checkout/route.ts` |
| **เตือนลืมเช็คเอาท์** | ก่อน Auto Checkout | `app/api/auto-checkout/route.ts` |

### ⚙️ การตั้งค่า (Admin Settings):

**หน้า:** `/admin/settings/notifications`

```
┌─────────────────────────────────────────┐
│ ✅ แจ้งเตือนเข้า-ออกงาน                   │
│    • แจ้งเตือนเมื่อเช็คอิน               │
│    • แจ้งเตือนเมื่อเช็คเอาท์             │
├─────────────────────────────────────────┤
│ ✅ แจ้งเตือน OT                          │
│    • แจ้งเมื่อมีคำขอ OT ใหม่            │
│    • แจ้งเมื่อ OT ได้รับการอนุมัติ       │
│    • แจ้งเมื่อเริ่มทำ OT                 │
│    • แจ้งเมื่อจบ OT                      │
├─────────────────────────────────────────┤
│ ✅ แจ้งเตือนวันหยุด                      │
│    • แจ้งล่วงหน้า: 1 วัน                │
│    • เวลาแจ้งเตือน: 09:00               │
├─────────────────────────────────────────┤
│ ✅ Auto Check-out                        │
│    • เวลา Auto Check-out: 23:00         │
│    • หลังเลิกงาน: 2 ชม.                 │
│    • ข้ามถ้ากำลังทำ OT                  │
│    • แจ้ง Admin เมื่อ Auto Check-out    │
├─────────────────────────────────────────┤
│ ✅ เตือนลืมเช็คเอาท์                    │
│    • ครั้งที่ 1: 60 นาที                │
│    • ครั้งที่ 2: 30 นาที                │
│    • ครั้งที่ 3: 15 นาที                │
└─────────────────────────────────────────┘
```

### 🔧 ต้องตั้งค่า LINE API:
1. ไปที่ `/admin/settings/line`
2. ใส่ **Channel Access Token**
3. ใส่ **Recipient ID** (User ID หรือ Group ID)
4. ✅ เปิดใช้งานการแจ้งเตือน

### 📍 Cron Jobs (Vercel):
```json
{
  "crons": [
    {
      "path": "/api/holiday-notifications",
      "schedule": "0 2 * * *"  // 09:00 GMT+7
    },
    {
      "path": "/api/auto-checkout",
      "schedule": "0 22 * * *" // 05:00 GMT+7 (ตรวจสอบตอน 22:00)
    }
  ]
}
```

---

## 🟡 2. PWA Notifications (Client-side)
**ส่งผ่าน Web Notifications API → แจ้งเตือนบน Browser**

### ⚠️ ข้อจำกัด:
- ⏰ ใช้ `setTimeout` = **ไม่ persistent**
- 🚫 หายเมื่อปิด browser/tab
- 📱 iOS: ต้องติดตั้งแอป + ใช้ iOS 16.4+
- 🔋 Android: ทำงานได้ดีกว่า
- 🌐 ทำงานบน Client (ในแอพพนักงาน)

### 📋 แจ้งเตือนอะไรบ้าง:

| เหตุการณ์ | เมื่อไร | ไฟล์ที่ใช้ |
|----------|---------|-----------|
| **Check-in Reminder** | ⏰ เวลาเข้างาน (08:30) | `lib/utils/notifications.ts` |
| **Check-out Reminder** | ⏰ เวลาออกงาน (17:30) | `lib/utils/notifications.ts` |

### ⚙️ การตั้งค่า (พนักงาน):

**หน้า:** `/notifications`

```
┌─────────────────────────────────────────┐
│ 🔔 เปิดการแจ้งเตือน                      │
├─────────────────────────────────────────┤
│ ⏰ แจ้งเตือนเช็คอิน                       │
│    เวลา 08:30 น.                        │
│    (อิงตาม work_start_time)             │
├─────────────────────────────────────────┤
│ 🏠 แจ้งเตือนเช็คเอาท์                    │
│    เวลา 17:30 น.                        │
│    (อิงตาม work_end_time)               │
└─────────────────────────────────────────┘
```

### 📝 หมายเหตุสำคัญ:
- ✅ พนักงานเปิด/ปิดการแจ้งเตือนได้
- ❌ **ไม่สามารถเปลี่ยนเวลาได้** (อิงตาม Admin)
- 🏖️ ระบบจะไม่แจ้งในวันหยุดโดยอัตโนมัติ
- 📱 ต้อง request permission จาก browser
- ⚠️ **ทำงานได้ดีถ้าแอปเปิดอยู่**

### 🔧 วิธีใช้งาน:
1. เปิดหน้า `/notifications`
2. กด "เปิดการแจ้งเตือน"
3. อนุญาต notification permission
4. ✅ เปิด/ปิด reminder ตามต้องการ
5. กด "บันทึกการตั้งค่า"

---

## 📊 สรุปเปรียบเทียบ

| คุณสมบัติ | LINE Notifications | PWA Notifications |
|----------|-------------------|-------------------|
| **ส่งผ่าน** | LINE App | Browser |
| **ทำงานได้จริง** | ✅ 100% | ⚠️ มีข้อจำกัด |
| **ปิด Browser** | ✅ ได้ | ❌ หาย |
| **ต้องตั้งค่า** | LINE API | Browser Permission |
| **ใครได้รับ** | Admin/Group | พนักงานแต่ละคน |
| **Persistent** | ✅ ใช่ | ❌ ไม่ใช่ |
| **iOS Support** | ✅ ดี | ⚠️ จำกัด |
| **Android Support** | ✅ ดี | ✅ ดี |

---

## 🎯 แนะนำการใช้งาน

### สำหรับ Admin:
1. **✅ ใช้ LINE Notifications เป็นหลัก**
   - ตั้งค่า LINE API ให้เรียบร้อย
   - เปิดการแจ้งเตือนที่ต้องการใน Admin Settings

2. **📱 PWA Notifications เป็นตัวช่วย**
   - ให้พนักงานเปิดใช้เองตามความต้องการ
   - เหมาะสำหรับพนักงานที่ต้องการ reminder

### สำหรับพนักงาน:
1. **LINE** → รับการแจ้งเตือนจาก Admin (OT อนุมัติ, วันหยุด, etc.)
2. **PWA** → ตั้ง reminder ส่วนตัว (เตือนเช็คอิน/เช็คเอาท์)

---

## 🔍 การตรวจสอบว่าใช้งานได้หรือไม่

### LINE Notifications:
1. ไปที่ `/admin/settings/line`
2. กด "ทดสอบส่งข้อความ"
3. ตรวจสอบใน LINE ว่าได้รับข้อความหรือไม่

### PWA Notifications:
1. ไปที่ `/notifications`
2. เปิดการแจ้งเตือน
3. กด "ทดสอบการแจ้งเตือน"
4. ควรเห็น notification ขึ้นบน browser

---

## 🐛 แก้ปัญหา

### LINE ไม่ส่ง:
- ✅ ตรวจสอบ Channel Access Token ถูกต้องหรือไม่
- ✅ ตรวจสอบ Recipient ID ถูกต้องหรือไม่
- ✅ ตรวจสอบเปิดการแจ้งเตือนใน Admin Settings หรือไม่
- ✅ ดู Console Log ในหน้า Admin (F12 → Console)

### PWA ไม่แจ้ง:
- ✅ ตรวจสอบ Notification Permission = "granted"
- ✅ ตรวจสอบแอปเปิดอยู่หรือไม่ (PWA ต้องเปิดอยู่)
- ✅ iOS: ต้องติดตั้งแอปผ่าน "Add to Home Screen"
- ✅ iOS: ใช้ iOS 16.4 ขึ้นไป
- ✅ ดู Console Log (F12 → Console)

---

## 📱 เส้นทางการตั้งค่า

```
Admin:
├── /admin/settings/line → ตั้งค่า LINE API
└── /admin/settings/notifications → ตั้งค่าการแจ้งเตือน LINE

พนักงาน:
└── /notifications → ตั้งค่าการแจ้งเตือน PWA
```

---

## 💡 สรุป

**LINE Notifications** = แจ้งเตือนจริงๆ ของระบบ (ใช้งานได้ 100%)
- เช็คอิน/เช็คเอาท์ เมื่อพนักงานลงเวลา
- OT อนุมัติ/ปฏิเสธ
- วันหยุด
- Auto checkout

**PWA Notifications** = Reminder ส่วนตัวสำหรับพนักงาน (มีข้อจำกัด)
- เตือนให้เช็คอิน
- เตือนให้เช็คเอาท์

**ใช้ทั้ง 2 ระบบควบคู่กันจะได้ประโยชน์สูงสุด!** 🎉

